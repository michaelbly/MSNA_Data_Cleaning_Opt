---
title: "Reach OPT MSNA 2021"
output:
  html_document: default
  pdf_document: default
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = FALSE,comment = NA, message = FALSE, warning=FALSE, fig.align = 'center' )
```
```{r, include=FALSE}
library(dplyr)
library(lubridate)
library(readxl)
library(kableExtra)
library(knitr)
library(readr)
library(openxlsx)
library(sf)
library(raster)
library(Hmisc)
library(rsconnect)
source("functions/audit_function_full.R")
source("functions/function_handler.R")

WGS84 <- crs("+init=epsg:4326")
UTM38N <- crs("+init=epsg:32638")

assessment_start_date <- as.Date("2021-06-15")

# set min time and max # interviews per day

time_limit <- 10
flag_time_limit <- 20
max_interv <- 10

# read data from excel file
##df <- read_excel("input/raw_data/Final__V10__REACH_oPt_Kobo_MSNA_May_2021_V8_27052021_-_all_versions_-_False_-_2021-06-07-08-58-28.xlsx", sheet = "MSNA_I_2021")
  
df <- read_excel("input/raw_data/FINAL_Pilot_V12_REACH_oPt_Kobo_MSNA_June_2021_13062021_2021-06-20-05-33-16.xlsx", sheet = "MSNA_I_2021")

  ###########################################################################################################
# time check from audit files
# today
df$today <- as.Date(df$start, "%Y-%m-%d")

df <- time_check_audit(audit_dir_path = "audit/", df,  "_uuid", time_limit = time_limit)

df <- time_check(df, time_limit)
df <- df %>% 
  mutate(time_validity = case_when(interview_duration < flag_time_limit & 
                                     interview_duration > time_limit ~ "Flagged", TRUE ~ time_validity))



###########################################################################################################
df$time_validity



# when survey does not continue to hh member calculation, these surveys are not valid

df <- df %>% 
  mutate(not_eligible = case_when(is.na(hh_size) ~ "yes",TRUE ~ "no"),
         uuid = `_uuid`,
         X_uuid = uuid)


df$not_eligible


############ add full strata
######NOTE ::: CHANGE THE OSLO AREA TO REFLECT THE TOOL, A, B, C
df <- df %>%
  mutate(across(everything(), as.character)) %>%
  mutate(strata =
           case_when(location == "west_bank" & (oslo_area == "area_a" | oslo_area == "area_b") ~ "Area_AB",
                     location == "west_bank" & oslo_area == "area_c" ~ paste(hh_location_wb, oslo_area, sep = "_"),
                     location == "gaza" ~ hh_location_gaza,
                     location == "ej"~ "East_Jerusalem",
                     TRUE  ~  'H2'))


#### df after the time check
#df_raw <- df
#write.xlsx(df_raw, (file = sprintf("output/df_raw_%s.xlsx", today())))

##########################################################################################
# Deleted interviews column
df <- df %>% 
  mutate(
    deleted = case_when(
      time_validity == "Deleted" | consent == "no" | not_eligible == "yes" ~ "yes",
      TRUE ~ "no"))
df$deleted
########## SAMPLE FRAMES ########################
# 
westbank_sample_df <- read_csv("input/sample/Final_sampling_frame_WestBank_95_9_CS 8_B 15.csv")

westbank_sample_df_summarized <- westbank_sample_df %>% 
                    rename(num_surveys = "Survey") %>% 
                    group_by(strata) %>% 
                    summarise(num_surveys = sum(num_surveys))


#westbank_sample_df_summarized <- write.csv(westbank_sample_df_summarized, sprintf("input/sample/westbank_sample_df_summarized_%s.csv", today()), row.names = FALSE)
                    
                     
                  

gaza_sample_df <- read_csv("input/sample/Final_sampling_summary_Gaza.csv") 

gaza_sample_df_summarized <- gaza_sample_df %>% 
                          rename(num_surveys = "# surveys") %>% 
                          group_by(strata) %>% 
                          summarise(num_surveys = sum(num_surveys))


#gaza_sample_df_summarized <- write.csv(gaza_sample_df_summarized, sprintf("input/sample/gaza_sample_df_summarized_%s.csv", today()), row.names = FALSE)
                          

east_Jerusalem_sample <- read_excel("input/sample/Final_sampling_frame_EJ_95_9_CS 5_B 15.xlsx")
ej_summarized_sample <- east_Jerusalem_sample %>% 
                        rename(num_surveys = "Survey") %>% 
                        group_by(strata) %>% 
                        summarise(num_surveys = sum(num_surveys))
  

#ej_sample_df_summarized <- write.csv(gaza_sample_df_summarized, sprintf("input/sample/ej_sample_df_summarized_%s.csv", today()), row.names = FALSE)
                          


############ add full strata
######NOTE ::: CHANGE THE OSLO AREA TO REFLECT THE TOOL, A, B, C
df <- df %>%
  mutate(across(everything(), as.character)) %>%
  mutate(strata =
           case_when(location == "west_bank" & (oslo_area == "A" | oslo_area == "B") ~ "Area_AB",
                     location == "west_bank" & oslo_area == "C" ~ paste(hh_location_wb, oslo_area, sep = "_"),
                     location == "gaza" ~ hh_location_gaza,
                     location == "ej"~ "East_Jerusalem",
                     TRUE  ~  'H2'))

##########################################################################################
# Deleted interviews column
df <- df %>% 
  mutate(
    deleted = case_when(
      time_validity == "Deleted" | consent == "no" | not_eligible == "yes" ~ "yes",
      TRUE ~ "no"))


########################################################################################

### Interview method 

interview_method <- df %>% 
  dplyr::select(Date = today,
         Enumerator = enumerator_num,
         Location = location,
         interview_type = dc_method) %>% 
 group_by(Location, interview_type) %>% tally(name = "Number_of_interviews")
interview_method
interview_method_date <- df %>% 
  dplyr::filter(today > assessment_start_date) %>% 
  dplyr::select(Date = today,
         Enumerator = enumerator_num,
         Location = location,
         interview_type = dc_method) %>% 
   group_by(interview_type, Date) %>% tally(name = "Number_of_interviews")
interview_method_date

library(plotly)
survey_method_graph <- plot_ly(interview_method_date, x = ~Date, y = ~Number_of_interviews, name = 'Number of Interviews Per Day', type = 'scatter', mode = 'lines',
        line = list(color = 'rgb(205, 12, 24)', width = 4))
survey_method_graph
# interview_method Wide format
interview_method_wide <- tidyr::pivot_wider(interview_method, 
                                            names_from = interview_type, 
                                            values_from = Number_of_interviews,
                                            values_fill = list(Number_of_interviews = 0))


interview_method_wide <- rename(interview_method_wide, "Number_of_interviews" = "in_person")
### Interview method Westbank 


interview_method_wb <- df %>%
  filter(!is.na(hh_location_wb)) %>% 
  dplyr::select(Date = today,
         Enumerator = enumerator_num,
         Governorate = hh_location_wb,
         interview_type = dc_method
  ) %>% 
 group_by(Governorate, interview_type) %>% tally(name = "Number_of_interviews")

interview_method_wb

interview_method_date_wb <- df %>% 
  dplyr::filter(today > assessment_start_date & !is.na(hh_location_wb)) %>% 
  dplyr::select(Date = today,
         Enumerator = enumerator_num,
         Governorate = hh_location_wb,
         interview_type = dc_method) %>% 
   group_by(interview_type, Date) %>% tally(name = "Number_of_interviews")

interview_method_date_wb

library(plotly)
survey_method_graph_wb <- plot_ly(interview_method_date_wb, x = ~Date, y = ~Number_of_interviews, name = 'Number of Interviews West Bank', type = 'scatter', mode = 'lines',
        line = list(color = 'rgb(205, 12, 24)', width = 4)) 
survey_method_graph_wb
# interview_method Wide format

interview_method_wide_wb <- tidyr::pivot_wider(interview_method_wb, 
                                            names_from = interview_type, 
                                            values_from = Number_of_interviews,
                                            values_fill = list(Number_of_interviews = 0))

interview_method_wide_wb

### Interview method Gaza


interview_method_gaza <- df %>%
  filter(!is.na(hh_location_gaza)) %>% 
  dplyr::select(Date = today,
         Enumerator = enumerator_num,
         Municipality = hh_location_gaza,
         interview_type = dc_method
  ) %>% 
 group_by(Municipality, interview_type) %>% tally(name = "Number_of_interviews")

interview_method_gaza

interview_method_date_gaza <- df %>% 
  dplyr::filter(today > assessment_start_date & !is.na(hh_location_gaza)) %>% 
  dplyr::select(Date = today,
         Enumerator = enumerator_num,
         Municipality = hh_location_gaza,
         interview_type = dc_method) %>% 
   group_by(interview_type, Date) %>% tally(name = "Number_of_interviews")
interview_method_date_gaza

library(plotly)
survey_method_graph_gaza <- plot_ly(interview_method_date_gaza, x = ~Date, y = ~Number_of_interviews, name = 'Number of Interviews Gaza', type = 'scatter', mode = 'lines',
        line = list(color = 'rgb(205, 12, 24)', width = 4)) 
survey_method_graph_gaza 
# interview_method Wide format
interview_method_wide_gaza <- tidyr::pivot_wider(interview_method_gaza, 
                                            names_from = interview_type, 
                                            values_from = Number_of_interviews,
                                            values_fill = list(Number_of_interviews = 0))

interview_method_wide_gaza

### Interview method East Jerusalem


interview_method_EJ <- df %>%
  filter(location == "ej") %>% 
  dplyr::select(Date = today,
         Enumerator = enumerator_num,
         Location = location,
         interview_type = dc_method
  ) %>% 
 group_by(Location, interview_type) %>% tally(name = "Number_of_interviews")
interview_method_EJ

interview_method_date_EJ <- df %>% 
  dplyr::filter(today > assessment_start_date & location == "ej") %>% 
  dplyr::select(Date = today,
         Enumerator = enumerator_num,
         Location = location,
         interview_type = dc_method) %>% 
   group_by(interview_type, Date) %>% tally(name = "Number_of_interviews")
interview_method_date_EJ

library(plotly)
survey_method_graph_EJ <- plot_ly(interview_method_date_EJ, x = ~Date, y = ~Number_of_interviews, name = 'Number of Interviews EJ', type = 'scatter', mode = 'lines',
        line = list(color = 'rgb(205, 12, 24)', width = 4)) 
survey_method_graph_EJ
# interview_method Wide format
interview_method_wide_EJ <- tidyr::pivot_wider(interview_method_EJ, 
                                            names_from = interview_type, 
                                            values_from = Number_of_interviews,
                                            values_fill = list(Number_of_interviews = 0))
interview_method_wide_EJ


## Tracking by Location:: West Bank

westbank_sample_inperson <- westbank_sample_df_summarized %>% 
                          dplyr::select(strata, Max_Surveys = num_surveys)
westbank_sample_inperson


westbank_tracking_inperson <- df %>% 
                              dplyr::filter(dc_method == "in_person" & location == "west_bank" | location == "H2") %>% 
                              dplyr::group_by(strata) %>% 
                              dplyr::summarise(Submissions = n(),
                              Short_intv = sum(time_validity == "Deleted", na.rm = T),
                              Deleted = sum(deleted == "yes", na.rm = T),
                              Accepted = sum(deleted == "no", na.rm = T)
                              )
westbank_tracking_inperson


westbank_tracking_merged_in_person <- left_join(westbank_sample_inperson, westbank_tracking_inperson, by = "strata") %>% 
  mutate(
    Remaining =  case_when(
      is.na(Accepted) ~ Max_Surveys,
      TRUE ~ (Accepted - Max_Surveys) * -1
    )
  )
func <- function(z) if (is.numeric(z)) sum(z, na.rm = T) else ''
sumrow_in_person <- as.data.frame(lapply(westbank_tracking_merged_in_person, func))
sumrow_in_person
westbank_tracking_merged_in_person <- rbind(westbank_tracking_merged_in_person, sumrow_in_person ) %>%
  mutate_all(funs(replace_na(.,0))) %>% 
  dplyr::mutate(Min_Surveys = round(Max_Surveys*0.85,0))
westbank_tracking_merged_in_person <- westbank_tracking_merged_in_person %>% 
          relocate(c("Min_Surveys"), .before = "Max_Surveys")
########################################################################################

########################################################################################

## Tracking by Location:: Gaza

gaza_sample_inperson <- gaza_sample_df_summarized %>% 
                          dplyr::select(strata, Max_Surveys = num_surveys)
gaza_sample_inperson


gaza_tracking_inperson <- df %>% 
                              dplyr::filter(dc_method == "in_person" & location == "gaza") %>% 
                              dplyr::group_by(strata) %>% 
                              dplyr::summarise(Submissions = n(),
                              Short_intv = sum(time_validity == "Deleted", na.rm = T),
                              Deleted = sum(deleted == "yes", na.rm = T),
                              Accepted = sum(deleted == "no", na.rm = T)
                              )
gaza_tracking_inperson


gaza_tracking_merged_in_person <- left_join(gaza_sample_inperson, gaza_tracking_inperson, by = "strata") %>% 
  mutate(
    Remaining =  case_when(
      is.na(Accepted) ~ Max_Surveys,
      TRUE ~ (Accepted - Max_Surveys) * -1
    )
  )
func <- function(z) if (is.numeric(z)) sum(z, na.rm = T) else ''
gaza_sumrow_in_person <- as.data.frame(lapply(gaza_tracking_merged_in_person, func))
gaza_sumrow_in_person
gaza_tracking_merged_in_person <- rbind(gaza_tracking_merged_in_person, gaza_sumrow_in_person ) %>%
  mutate_all(
    funs(replace_na(.,0))) %>% 
dplyr::mutate(Min_Surveys = round(Max_Surveys*0.90,0))
gaza_tracking_merged_in_person <- gaza_tracking_merged_in_person %>% 
          relocate(c("Min_Surveys"), .before = "Max_Surveys")
gaza_tracking_merged_in_person


## Tracking by Location:: East Jerusalem

EJ_sample_inperson <- ej_summarized_sample %>% 
                          dplyr::select(strata, Max_Surveys = num_surveys)
EJ_sample_inperson


EJ_tracking_inperson <- df %>% 
                              dplyr::filter(dc_method == "in_person" & location == "ej") %>% 
                              dplyr::group_by(strata) %>% 
                              dplyr::summarise(Submissions = n(),
                              Short_intv = sum(time_validity == "Deleted", na.rm = T),
                              Deleted = sum(deleted == "yes", na.rm = T),
                              Accepted = sum(deleted == "no", na.rm = T)
                              )
EJ_tracking_inperson


EJ_tracking_merged_in_person <- left_join(EJ_sample_inperson, EJ_tracking_inperson, by = "strata") %>% 
  mutate(
    Remaining =  case_when(
      is.na(Accepted) ~ Max_Surveys,
      TRUE ~ (Accepted - Max_Surveys) * -1
    )
  )
func <- function(z) if (is.numeric(z)) sum(z, na.rm = T) else ''
EJ_sumrow_in_person <- as.data.frame(lapply(EJ_tracking_merged_in_person, func))
EJ_sumrow_in_person
EJ_tracking_merged_in_person <- rbind(EJ_tracking_merged_in_person, EJ_sumrow_in_person ) %>%
  mutate_all(
    funs(replace_na(.,0))) %>% 
dplyr::mutate(Min_Surveys = round(Max_Surveys*0.85,0))
EJ_tracking_merged_in_person <- EJ_tracking_merged_in_person %>% 
          relocate(c("Min_Surveys"), .before = "Max_Surveys")
EJ_tracking_merged_in_person

########################################################################################
# Started before date of data collection
started_before <- df %>% 
  filter(today < assessment_start_date) %>% 
  dplyr::select(Date = today,
         Enumerator = enumerator_num,
         Location = location)
started_before

# Enumerator productivity

enumerator_productivity <- df %>% 
  filter(df$consent == "yes") %>% 
  group_by(Date = today, Enumerator = enumerator_num) %>% 
  summarise(Interviews = n())

enumerator_productivity_many <- enumerator_productivity %>% 
  dplyr::filter(Interviews > max_interv)

enumerator_productivity_less <- enumerator_productivity %>% 
  dplyr::filter(Interviews < 3)

enumerator_productivity_final <- rbind(enumerator_productivity_many, enumerator_productivity_less)%>% 
  dplyr::select(Enumerator, Interviews) %>% 
  arrange(desc(Enumerator))

enum_productivity <- df %>% 
  filter(df$consent == "yes") %>% 
  group_by(Enumerator = enumerator_num) %>% 
  summarise(Interviews = n()) %>% 
  arrange(desc(Interviews), .by_group = T)




  

# Enumerator per survey status 

enumer_per_survey_status <- df %>% 
  filter(df$consent == "yes") %>% 
  group_by(Date = today, Enumerator = enumerator_num) %>% 
  summarise(Accepted = sum(time_validity != "Deleted", na.rm = T),
            Deleted = sum(time_validity == "Deleted", na.rm = T )
  )
enumer_per_survey_status


# Survey status per day 

survey_status_per_day <- df %>% 
    filter(df$consent == "yes") %>% 
  group_by(Date = today) %>% 
  summarise(Accepted = sum(time_validity != "Deleted", na.rm = T),
            Deleted = sum(time_validity == "Deleted", na.rm = T )
  )
survey_status_per_day

survey_len <- df %>% 
  filter(consent == "yes" & enumerator_num == "1") %>% 
  dplyr::select(interview_duration)
# survey length by enumerator
survey_length <- df %>% 
    filter(df$consent == "yes") %>% 
  group_by(Enumerator = enumerator_num) %>% 
 summarise(
    Median_duration = round(median(as.numeric(interview_duration), na.rm = T),0)
  )%>% 
  dplyr::arrange(desc(Median_duration) )

overall_survey_median <- round(median(as.numeric(df$interview_duration), na.rm = T),0)

survey_length$Overall_median <-  overall_survey_median

# Enumerator with short interv duration
short_interviews_by_enum <- df %>% 
  dplyr::filter(df$consent == "yes" ) %>% 
  dplyr::filter(interview_duration < time_limit & today > "2021-06-15") %>% 
  
  dplyr::select(Date = today, 
                Enumerator = enumerator_num, 
                Location = location,
                Duration =  interview_duration,
                Interview_Type = dc_method
  ) %>% mutate(
    Duration = round(as.numeric(Duration),0),
  ) %>% 
  arrange(desc(Date) )
short_interviews_by_enum
```

<center> **Data Collection Monitoring Report** </center>


# {.tabset}

***
## Progress Statistics

<center>**Number surveys per day of data collection** </center> </br>

```{r eval=TRUE, echo=FALSE, results='asis'}
kable(survey_status_per_day)%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),fixed_thead = T, full_width = F)
```
<center>**Completed Interviews**</center> </br>

```{r eval=TRUE, echo=FALSE, results='asis'}

kable(interview_method_wide)%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),fixed_thead = T, full_width = F)
```
***

## Enumerator Progress

<center>**Number of surveys per day by enumerator** </center> </br>

```{r eval=TRUE, echo=FALSE, results='asis'}

DT::datatable(enumer_per_survey_status,
              options = list(
                  pageLength = 2000,
                  dom = 'ft'
                )
  ) %>% 
  DT::formatStyle('Deleted',  color = 'red', fontWeight = 'bold') %>% 
  DT::formatStyle('Accepted',  color = 'green', fontWeight = 'bold')

```

##  Enumerator Productivity

<center>**Surveyors with very low or high productivity** </center> </br>

```{r eval=TRUE, echo=FALSE, results='asis'}
kable(enum_productivity)%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),fixed_thead = T, full_width = F)
```



## General Checks  

<center>**surveys collected in under `r time_limit` minutes - last 7 days** </center> </br>
  
```{r eval=TRUE, echo=FALSE, results='asis'}
kable(short_interviews_by_enum)%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),fixed_thead = T, full_width = F)
```



***



<center>**Median interview duration by enumerator** </center> </br>

```{r eval=TRUE, echo=FALSE, results='asis'}
kable(survey_length)%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),fixed_thead = T, full_width = F)
```
<center>**Surveys made before the first day of data collection (**`r assessment_start_date`**)**</center> </br>

```{r eval=TRUE, echo=FALSE, results='asis'}
kable(started_before)%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),fixed_thead = T, full_width = F)
```


***


## West Bank Interviews Tracking

```{r eval=TRUE, echo=FALSE, results='asis'}
DT::datatable(westbank_tracking_merged_in_person,
              options = list(
                  pageLength = 130,
                  dom = 'ft'
                )
              ) %>% 
  DT::formatStyle('Deleted',  color = 'red', fontWeight = 'bold') %>% 
  DT::formatStyle('Accepted',  color = 'green', fontWeight = 'bold') %>% 
  DT::formatStyle('Short_intv',  color = 'red', fontWeight = 'bold') %>%
  DT::formatStyle('Remaining', fontWeight = 'bold')
```

## Gaza Interviews Tracking

```{r eval=TRUE, echo=FALSE, results='asis'}
DT::datatable(gaza_tracking_merged_in_person,
              options = list(
                  pageLength = 130,
                  dom = 'ft'
                )
              ) %>% 
  DT::formatStyle('Deleted',  color = 'red', fontWeight = 'bold') %>% 
  DT::formatStyle('Accepted',  color = 'green', fontWeight = 'bold') %>% 
  DT::formatStyle('Short_intv',  color = 'red', fontWeight = 'bold') %>%
  DT::formatStyle('Remaining', fontWeight = 'bold')
```

## East Jerusalem Interviews Tracking

```{r eval=TRUE, echo=FALSE, results='asis'}
DT::datatable(EJ_tracking_merged_in_person,
              options = list(
                  pageLength = 130,
                  dom = 'ft'
                )
              ) %>% 
  DT::formatStyle('Deleted',  color = 'red', fontWeight = 'bold') %>% 
  DT::formatStyle('Accepted',  color = 'green', fontWeight = 'bold') %>% 
  DT::formatStyle('Short_intv',  color = 'red', fontWeight = 'bold') %>%
  DT::formatStyle('Remaining', fontWeight = 'bold')
```











